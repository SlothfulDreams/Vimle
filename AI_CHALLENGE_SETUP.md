# AI Challenge Generation Setup

This document explains how to enable and use Google Gemini API for dynamic challenge generation in Vimle.

## Quick Setup

1. **Get Google AI API Key**:
   - Go to [Google AI Studio](https://makersuite.google.com/app/apikey)
   - Create a new API key for Gemini
   - Copy the API key

2. **Add to Environment Variables**:

   ```bash
   # Add to your .env file
   GEMINI_API_KEY=your-api-key-here
   GEMINI_MODEL=gemini-1.5-flash  # Optional, defaults to gemini-1.5-flash
   ```

3. **Restart Your Development Server**:

   ```bash
   pnpm dev
   ```

## How It Works

### Automatic Fallback System

- **With API Key**: Generates fresh challenges daily using AI
- **Without API Key**: Uses static challenge pool (existing behavior)
- **API Failure**: Automatically falls back to static challenges

### Challenge Generation Flow

1. **Check Database**: Looks for existing challenge for today
2. **Generate if Missing**: Creates new challenge via Gemini API
3. **Validate**: Ensures generated code is syntactically correct
4. **Store**: Saves challenge to database for consistency
5. **Fallback**: Uses static pool if any step fails

### Difficulty Rotation

Challenges automatically cycle through difficulties:

- Day 1: Easy
- Day 2: Medium
- Day 3: Hard
- Day 4: Easy (repeats)

## API Endpoints

### New tRPC Endpoints

```typescript
// Get today's challenge (AI-generated or static)
const challenge = await trpc.getTodaysChallenge.query();

// Check if AI generation is enabled
const status = await trpc.getAIStatus.query();

// Force regenerate today's challenge (admin)
const result = await trpc.regenerateTodaysChallenge.mutate({
  forceAI: true, // Optional: force AI even if disabled
});
```

## Database Schema

New fields added to `Challenge` model:

```prisma
model Challenge {
  // ... existing fields
  prompt_used       String?  // AI prompt that generated the challenge
  generated_by      String   // "static" | "gemini"
  validation_status String   // "pending" | "validated" | "failed"
}
```

## Prompt Engineering

The system uses structured prompts for each difficulty:

### Easy Challenges

- 3-5 lines of code
- Basic syntax (variables, simple functions)
- No complex algorithms

### Medium Challenges

- 6-10 lines of code
- Intermediate concepts (objects, arrays, loops)
- Moderate complexity

### Hard Challenges

- 8-15 lines of code
- Advanced concepts (classes, recursion, algorithms)
- Complex logic requiring careful editing

## Error Handling

### Automatic Retries

- 3 retry attempts for failed API calls
- Exponential backoff between retries
- Falls back to static after all retries fail

### Validation

- Checks generated code syntax
- Validates response format
- Ensures reasonable code length (20-2000 characters)

### Monitoring

Check server logs for generation status:

```bash
# Success
Generated and stored new gemini challenge: Array Manipulation

# Fallback
All AI generation attempts failed, falling back to static challenge

# Disabled
Gemini not enabled, using static challenge
```

## Development & Testing

### Test AI Generation

```typescript
import { generateTodaysChallenge } from "@/lib/gemini-challenge-generator";

// Generate a challenge
const result = await generateTodaysChallenge();
console.log(result.challenge);
console.log("Generated by:", result.generatedBy);
```

### Batch Generation (Testing)

```typescript
import { batchGenerateChallenges } from "@/lib/gemini-challenge-generator";

// Generate challenges for next 7 days
const challenges = await batchGenerateChallenges("2025-08-22", 7);
```

## Production Considerations

### API Costs

- Gemini 1.5 Flash: ~$0.075 per 1M tokens
- Daily challenge: ~100-200 tokens per generation
- Monthly cost: < $1 for typical usage

### Rate Limits

- Built-in retry logic handles temporary rate limits
- Automatic fallback prevents service disruption

### Monitoring

- Server logs track generation success/failure
- Database stores generation metadata
- Admin endpoint allows manual regeneration

## Troubleshooting

### "Gemini not enabled" Message

- Check if `GEMINI_API_KEY` is set in .env
- Restart development server after adding key
- Verify API key is valid at Google AI Studio

### Generation Failures

- Check server console for detailed error messages
- Verify internet connection for API calls
- API quota/billing issues will fall back to static challenges

### Invalid Generated Code

- System automatically validates and retries
- Persistent failures fall back to static challenges
- Check prompt templates if issues persist

## Benefits

✅ **Unlimited Unique Challenges**: Never repeat content  
✅ **Automatic Fallback**: Always works, even without API  
✅ **Type Safety**: Full TypeScript integration  
✅ **Error Resilience**: Multiple layers of error handling  
✅ **Cost Effective**: Minimal API usage costs  
✅ **Zero Configuration**: Works out of the box without API key

## Next Steps

1. **Scheduled Generation**: Add cron jobs for pre-generation
2. **Theme Support**: Holiday/event-themed challenges
3. **Difficulty Adjustment**: User-based difficulty preferences
4. **Admin Dashboard**: UI for monitoring and manual generation
5. **Challenge Categories**: Different programming languages/concepts

